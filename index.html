<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hệ Thống PCCC 3 Line 15kW (MQTT)</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Segoe UI',sans-serif;color:#fff;background:#222;}
.container{max-width:1100px;margin:20px auto;padding:20px;}
.header{text-align:center;margin-bottom:20px;}
.header h1{font-size:28px;}
.tabs{display:flex;justify-content:center;margin-bottom:20px;flex-wrap:wrap;}
.tab-btn{padding:10px 20px;margin:5px;background:#333;color:#fff;border:none;border-radius:8px;cursor:pointer;}
.tab-btn.active{background:#d32f2f;}
.tab-content{display:none;padding:20px;background:rgba(255,255,255,0.1);border-radius:12px;margin-bottom:15px;}
.tab-content.active{display:block;}
.line-card{background:rgba(0,0,0,0.4);padding:15px;margin:10px;border-radius:12px;display:flex;align-items:center;justify-content:space-between;}
.stat{background:rgba(255,255,255,0.2);padding:10px;border-radius:8px;text-align:center;margin:5px;}
.btn{padding:10px 20px;margin:5px;font-size:16px;border:none;border-radius:8px;cursor:pointer;}
.on{background:#4caf50;color:white;}
.off{background:#f44336;color:white;}
.alarm{background:#ff9800;animation:blink 1s infinite;}
.fan{width:50px;height:50px;transition:transform 0.2s linear;}
.spin{animation:spin 1s linear infinite;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0.5}}
@keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
</style>
</head>
<body>
<div class="container">
  <div class="header"><h1>Hệ Thống Điều Khiển Giám Sát PCCC 3 Line 15kW</h1></div>

  <div class="tabs">
    <button class="tab-btn active" onclick="openTab('monitor')">GIÁM SÁT</button>
    <button class="tab-btn" onclick="openTab('control')">ĐIỀU KHIỂN</button>
    <button class="tab-btn" onclick="openTab('alert')">CẢNH BÁO</button>
    <button class="tab-btn" onclick="openTab('settings')">CÀI ĐẶT</button>
  </div>

  <!-- GIÁM SÁT -->
  <div id="monitor" class="tab-content active">
    <div class="line-card"><h3>Line 1</h3><div class="grid" id="l1"></div></div>
    <div class="line-card"><h3>Line 2</h3><div class="grid" id="l2"></div></div>
    <div class="line-card"><h3>Line 3</h3><div class="grid" id="l3"></div></div>
    <div class="stat">Nhiệt độ: <span id="temp">--</span>°C | Độ ẩm: <span id="hum">--</span>%</div>
  </div>

  <!-- ĐIỀU KHIỂN -->
  <div id="control" class="tab-content">
    <div class="line-card">
      <div>
        <h3>Line 1</h3>
        <button class="btn on" onclick="sendCommand(1,'on')">BẬT</button>
        <button class="btn off" onclick="sendCommand(1,'off')">TẮT</button>
      </div>
      <img id="fan1" src="https://img.icons8.com/?color=000000&format=png&id=YL8s-cZFMgGT&size=100" class="fan">
    </div>
    <div class="line-card">
      <div>
        <h3>Line 2</h3>
        <button class="btn on" onclick="sendCommand(2,'on')">BẬT</button>
        <button class="btn off" onclick="sendCommand(2,'off')">TẮT</button>
      </div>
      <img id="fan2" src="https://img.icons8.com/?color=000000&format=png&id=YL8s-cZFMgGT&size=100" class="fan">
    </div>
    <div class="line-card">
      <div>
        <h3>Line 3</h3>
        <button class="btn on" onclick="sendCommand(3,'on')">BẬT</button>
        <button class="btn off" onclick="sendCommand(3,'off')">TẮT</button>
      </div>
      <img id="fan3" src="https://img.icons8.com/?color=000000&format=png&id=YL8s-cZFMgGT&size=100" class="fan">
    </div>
  </div>

  <!-- CẢNH BÁO -->
  <div id="alert" class="tab-content">
    <div class="stat alarm" id="alarm-msg">Không có cảnh báo</div>
  </div>

  <!-- CÀI ĐẶT -->
  <div id="settings" class="tab-content">
    <div class="stat">Kết nối MQTT HiveMQ</div>
    <div class="stat">Cập nhật real-time</div>
  </div>
</div>

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script>
let client;
const topicStatus = "pccc/3line/status";
const topicControl = "pccc/3line/control";

function connectMQTT() {
    client = mqtt.connect("wss://broker.hivemq.com:8000/mqtt");

    client.on('connect', () => {
        console.log('✅ MQTT Connected');
        client.subscribe(topicStatus, (err)=> {
            if(!err) console.log('Subscribed to status topic');
        });
    });

    client.on('message', (topic, message) => {
        if(topic === topicStatus){
            const data = JSON.parse(message.toString());
            updateUI(data);
        }
    });

    client.on('error', (err) => console.error('MQTT Error:', err));
}

function sendCommand(line, cmd){
    if(client && client.connected){
        client.publish(topicControl, `line:${line}:${cmd}`);
    }
}

function updateUI(data){
    ['l1','l2','l3'].forEach((id,i)=>{
        const l = data.lines[i];
        document.getElementById(id).innerHTML = `
            <div class="stat">Trạng thái: <strong>${l.state?'BẬT':'TẮT'}</strong></div>
        `;
        const fan = document.getElementById('fan'+(i+1));
        if(l.state) fan.classList.add('spin'); else fan.classList.remove('spin');
    });
    document.getElementById('temp').innerText = data.temp.toFixed(1);
    document.getElementById('hum').innerText = data.hum.toFixed(1);

    const alarm = document.getElementById('alarm-msg');
    const anyAlarm = data.lines.some(l=>l.state && data.temp>50); // ví dụ cảnh báo nếu nhiệt cao
    alarm.textContent = anyAlarm ? 'CẢNH BÁO: Quá tải / Nhiệt độ cao!' : 'Hệ thống an toàn';
    if(anyAlarm) alarm.classList.add('alarm'); else alarm.classList.remove('alarm');
}

function openTab(tab){
    document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    document.getElementById(tab).classList.add('active');
    document.querySelector(`button[onclick="openTab('${tab}')"]`).classList.add('active');
}

connectMQTT();
</script>
</body>
</html>
